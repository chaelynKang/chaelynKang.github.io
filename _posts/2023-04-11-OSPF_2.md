---
layout: single
title: " OSPF 2일차 "
categories: keduit
tags: [ OSPF, DynamicRouting, Protocol, ]
toc: true 
comments: true
author_profile: true
sidebar:
    nav: "docs"
---

# OSPF 실습 2일차

![image](https://user-images.githubusercontent.com/128279031/231062017-a38b89a8-8f66-418f-9be8-39eaa4ca209b.png)

* Neighbor 관계 R1 - R2 : NBMA // R2 - R3 : P-to-M

```
# 공통 설정

en
conf t
no ip domain lookup
line c 0
exec-timeout 0
logg syn
exit
int s1/0
no shut
encap fram
no fram inver
clock rate 64000
exit
hostname 
```

```
# IP Address & Mapping 

R1]
conf t
int l0
ip add 11.11.1.1 255.255.255.0
exit
int s1/0
ip add 11.11.12.1 255.255.255.0
fram map ip 11.11.12.2 102 br

R2]
conf t
int l0
ip add 11.11.2.2 255.255.255.0
exit
int s1/0.12 m
ip add 11.11.12.2 255.255.255.0
fram map ip 11.11.12.1 201 br
exit
int s1/0.23 m
ip add 11.11.23.2 255.255.255.0
fram map ip 11.11.23.3 203 br

R3]
conf t
int l0
ip add 11.11.3.3 255.255.255.0
exit
int s1/0.23 m
ip add 11.11.23.3 255.255.255.0
fram map ip 11.11.23.2 302 br
exit
int s1/0.34 p
ip add 11.11.34.3 255.255.255.0
fram inter 304

R1]
conf t
int l0
ip add 11.11.11.11 255.255.255.0
exit
int s1/0.34 p
ip add 11.11.34.11 255.255.255.0
fram inter 403
```

```
# OSPF 

R1]
conf t
router ospf 11
router-id 11.11.1.1
network 11.11.1.1 0.0.0.0 area 12
network 11.11.12.1 0.0.0.0 area 12

R2]
conf t
router ospf 11
router-id 11.11.2.2
network 11.11.2.2 0.0.0.0 area 12
network 11.11.12.2 0.0.0.0 area 12
network 11.11.23.2 0.0.0.0 area 0

R3]
conf t
router ospf 11
router-id 11.11.3.3
network 11.11.3.3 0.0.0.0 a 34
network 11.11.23.3 0.0.0.0 a 0
network 11.11.34.3 0.0.0.0 a 34

R4]
conf t
router ospf 11
router-id 11.11.4.4
router-id 11.11.4.4
network 11.11.4.4 0.0.0.0 a 34
network 11.11.34.4 0.0.0.0 a 34
```

```
# Neighbor 

R1]
conf t
router ospf 11
neighbor 11.11.12.2

R2]
conf t
int s1/0.23
ip ospf network point-to-multi

R3]
conf t
int s1/0.23
ip ospf network point-to-multi
```

---

# OSPF Neighbor 상태의 변화

* 일반적으로 OSPF가 설정된 인터페이스에서 Neighbor의 상태는 네이버가 없는 down 상태에서 시작하여, 네이버와 라우팅 정보 교환을 끝낸 full 상태로 변한다.

1. `Down` : neighbor 에게서 hello packet을 받지 못한 상태이다.

2. `attempt` : NBMA 네트워크에서만 적용되는 상태이다. OSPF 프로세스에서 Neighbor 명령어를 사용하여 지정한 네이버에서 헬로 패킷을 수신하지 못한 상태를 뜻함.

3. `init` : 네이버에게서 헬로 패킷을 받았으나 상대 라우터는 아직 나의 헬로 패킷을 수신하지 못한 상태이다.

4. `two-way` : OSPF 네이버와 쌍방향 통신이 이루어진 상태이다. 즉, 서로의 받은 hello packet 안에 router-id가 존재한다. BMA 또는 NBMA 라면 이 단계에서 DR/BDR 선출을 한다. 선출에 걸리는 시간은 hello의 4배 이다. 
two-way 상태에서 바로 DR/BDR을 선출하지 않고 모든 네이버에게 공정하게 DR/BDR로 선출되는 기회를 부여하기 위하여 wait-time 시간만큼 기다린다.
Wait-time은 데드주기와 동일하다. DRother 라우터끼리는 라우팅 정보를 교환하지 않으므로, 즉 adjacency를 맺지 안았음으로, 네이버 상태가 two-way 상태로 남아있게 된다. DR 또는 BDR 라우터들과는 다음 단계인 exstart 상태로 진행된다.

5. `exstart` : 라우터 정보를 교환하는 adjacency neighbor가 되는 첫 단계이다. 마스터 라우터와 슬레이브 라우터를 선출한다. Router-ID가 높은 라우터가 마스터로 선정된다. 또, DDP (Database Description Packet) 패킷 교환시 사용하는 DDP 패킷의 순서번호를 결정한다. 

6. `exchange` : OSPF의 라우팅 정보를 LSA (Link State Advertisement) 라고 한다. 이 LSA를 저장하는 장소를 Link-state database라고 하고, OSPF 라우터 자신이 알고 있는 모든 상세 네트워크 정보가 저장되어 있다. LSA의 헤더만을 DDP (Database Description Packet) 또는 DBD(DataBase Description) 라고 부르는 패킷에 담아 상대방에게 전송한다. DDP 패킷을 수신한 라우터는 자신의 Link-state database의 내용과 비교해보고, 자신에게 없거나 자신의 정보가 더 오래된 것 이면 상대방에게 상세한 기록을 해둔다. 상대방으로부터 DDP 수신이 끝난 후 ,link-state 요청 리스트에 기록해 둔 것이 없으면 바로 full 상태로 된다.

7. `Loading` : 상대로부터 DDP 수신이 끝난 후, Link-state 요청 리스트에 기록해 둔 것이 있으면, LSP (Link-State-Packet)을 보내서 특정 LSA의 상세 정보를 보내줄 것을 요청하여 해당 정보를 수신하는 단계이다.

8. `Full` : adjacent router들간에 라우틸 정보 교환이 끝난 상태이다.

---

## OSPF Neighbor 상태 변화 - 실습

```
R1]
Conf t
Int s1/0
Shut
End
Deb ip ospf adj
Deb ip ospf events
Conf t
Int s1/0
Do show clock
No shut

=> 상태 변화의 과정을 확인할 수 있다.
```

---

# OSPF Packet

* Hello : 인접 OSPF Device와 Hello 메시지를 교환하여 네이버 관계를 형성하고, 유지(keepalive)한다.

* OSPF의 경우 다음 조건이 일치해야만 Neighbor 관계를 형성한다.

```
- Area ID 
- Authentication(인증) 
- Subnet mask 
- Stub Flag
- Hello와 Dead interval
```

* OSPF의 경우 다음과 같이 neighbor를 구분한다.

* 일반 Neighbor : 위의 조건이 일치하는 경우 일반 Neighbor 관계를 형성한
다. Hello 메시지는 주기적으로 교환하지만 실제 LSA 정보는 교환하지 않는
다. (Two-way 상태)


* adjacent Neighbor : 일반 Neighbor 관계에서 아래 조건이 일치할 경우 
`adjacent neighbor` 관계를 형성한다. Hello 메시지 뿐 아니라 LSA 정보
도 교환한다. (Full 상태)

```
 - Point-to-Point 네트워크(PPP/HDLC)로 연결된 Router.
 - DR과 DROTHER Router.
 - BDR과 DROTER Router.
 - Virtual-link로 연결된 Router.
```
---